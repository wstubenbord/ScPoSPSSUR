<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Statistical Programming for the Social Sciences Using R - 8&nbsp; Web Scraping and Map Making</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./homework-1.html" rel="next">
<link href="./inference-continued.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="site_libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="site_libs/leaflet-1.3.1/leaflet.js"></script>
<link href="site_libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="site_libs/proj4-2.6.2/proj4.min.js"></script>
<script src="site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="site_libs/leaflet-binding-2.2.2/leaflet.js"></script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./scraping-and-maps.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Web Scraping and Map Making</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Statistical Programming for the Social Sciences Using R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/wstubenbord/ScPoSPSSUR" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Download" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download"><i class="bi bi-download"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./Statistical-Programming-for-the-Social-Sciences-Using-R.pdf">
              <i class="bi bi-bi-file-pdf pe-1"></i>
            Download PDF
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./Statistical-Programming-for-the-Social-Sciences-Using-R.epub">
              <i class="bi bi-bi-journal pe-1"></i>
            Download ePub
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro-to-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">An Introduction to <code>R</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./working-with-data-in-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Working with Data in <code>R</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summarizing-with-dplyr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Summarizing Data with <code>dplyr</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualizing-with-ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Visualizing with <code>ggplot2</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflows-and-wrangling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Workflows and Wrangling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./linear-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Linear Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inference-continued.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Linear Regression and Inference for Categorical Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./scraping-and-maps.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Web Scraping and Map Making</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Assignments</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./homework-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 1</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./homework-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 2</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./homework-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 3</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./homework-4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 4</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./homework-5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework 5</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Appendix</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./web-scraping-exercise.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Web-Scraping Exercise</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#web-scraping" id="toc-web-scraping" class="nav-link active" data-scroll-target="#web-scraping"><span class="header-section-number">8.1</span> Web Scraping</a>
  <ul class="collapse">
  <li><a href="#ethical-considerations-and-the-law" id="toc-ethical-considerations-and-the-law" class="nav-link" data-scroll-target="#ethical-considerations-and-the-law"><span class="header-section-number">8.1.1</span> Ethical Considerations and the Law</a></li>
  <li><a href="#an-example" id="toc-an-example" class="nav-link" data-scroll-target="#an-example"><span class="header-section-number">8.1.2</span> An Example</a></li>
  <li><a href="#using-rvest" id="toc-using-rvest" class="nav-link" data-scroll-target="#using-rvest"><span class="header-section-number">8.1.3</span> Using <code>rvest</code></a></li>
  <li><a href="#finding-data-in-the-html" id="toc-finding-data-in-the-html" class="nav-link" data-scroll-target="#finding-data-in-the-html"><span class="header-section-number">8.1.4</span> Finding Data in the HTML</a></li>
  <li><a href="#data-cleaning" id="toc-data-cleaning" class="nav-link" data-scroll-target="#data-cleaning"><span class="header-section-number">8.1.5</span> Data Cleaning</a></li>
  </ul></li>
  <li><a href="#making-maps" id="toc-making-maps" class="nav-link" data-scroll-target="#making-maps"><span class="header-section-number">8.2</span> Making Maps</a>
  <ul class="collapse">
  <li><a href="#an-interactive-map" id="toc-an-interactive-map" class="nav-link" data-scroll-target="#an-interactive-map"><span class="header-section-number">8.2.1</span> An Interactive Map</a></li>
  <li><a href="#choropleth-maps" id="toc-choropleth-maps" class="nav-link" data-scroll-target="#choropleth-maps"><span class="header-section-number">8.2.2</span> Choropleth Maps</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">8.3</span> Exercises</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Web Scraping and Map Making</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>At this point in the course, we’ve covered the essentials of statistical programming in R from data wrangling to implementing methods for inference. Now we turn to some more specialized tools for answering more specific questions: web scraping and maps. Ordinarily, we wouldn’t combine these topics, but the plebiscite conducted this past week via Google Forms resulted in a tie requiring us to address them both. So we shall.</p>
<p>Let’s be clear about what we are talking about first though. Web scraping is simply the taking of data from web pages online. Its useful for those tricky cases where some website has some desirable data posted somewhere, but it doesn’t come in one of those nice, pre-packaged formats that we’ve grown to expect (like a CSV or an Excel spreadsheet). This can be for a variety of reasons: the creator didn’t think someone would be interested in using their data; they didn’t have the wherewithal to post it in an accessible format; they wanted people to read it, but don’t want someone to use it; or, perhaps they just wanted to give us a challenge. The third case poses some ethical questions, which we’ll discuss briefly.</p>
<p>Choropleth maps, the type of map mentioned in the poll, on the other hand, are a form of data visualization. More specifically, they are a type of map in which some statistic is summarized across some unit of geography, the values for which are displayed via some visual scale (usually color). The results can be attractive and they can convey a large amount of information quickly. They’ve become popular in media these days, especially around election times in major news publications. We’ll take the liberty of discussing other types of maps, which might lack a scaled overlay, here as well.</p>
<section id="web-scraping" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="web-scraping"><span class="header-section-number">8.1</span> Web Scraping</h2>
<p>As you might have noticed in your years of browsing, websites are diverse in <a href="https://cat-bounce.com">form</a> and <a href="https://pointerpointer.com/">content</a>. Thankfully, however, they all follow some basic rules, chief amongst which is the requirement that they use HTML (HyperText Markup Language). HTML is a text-encoding language which provides the structure and content of websites. It looks something like this in its raw form:</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;

&lt;h1&gt;My First Heading&lt;/h1&gt;
&lt;p&gt;My first paragraph.&lt;/p&gt;

&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>When you navigate to a website, your browser automatically translates the underlying HTML into the formatted version you are accustomed to seeing in your daily browsing. Websites use other languages to display information as well, such as JavaScript, which allows for dynamic interaction with web pages, or CSS, which helps ensure consistent formatting. HTML remains the core language for web page browsing however.</p>
<p>Great, so web pages are generally made of HTML (along with content served up in other languages) - so what? Well, when a web page has data that we want it is usually embedded in the HTML. Web scraping means pulling all of the HTML from a web page, getting rid of the unnecessary HTML so that only the underlying data remains, and then transforming that data into a format that allows us to use it. Our trusty companion <code>R</code> has packages that can help us do this.</p>
<section id="ethical-considerations-and-the-law" class="level3" data-number="8.1.1">
<h3 data-number="8.1.1" class="anchored" data-anchor-id="ethical-considerations-and-the-law"><span class="header-section-number">8.1.1</span> Ethical Considerations and the Law</h3>
<p>First, let’s address the elephant in the room: is it legal? After all, we’re talking about taking data from other people’s websites using computer code. When you put it in those terms, it begins to sound a bit like hacking, no? The answer is that it depends. It depends on the type of data (public or private), relevant copyright law (what are you going to do with it?), and how you actually take the data (did you break the website while doing it? Did you access a non-public page?). It may also depend on whether the website owner allows web scraping or not, although this may matter less than some of the other considerations.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>It may be worth mentioning here that I am not a lawyer and this is not legal advice. The legality of web scraping depends on the specific context. You can find some discussion of the legal issues involved in <a href="https://r4ds.hadley.nz/webscraping">Chapter 24</a> of Wickham et al.’s <em>R for Data Science</em> textbook. My personal view is that as long as a webpage is publicly accessible, you are being careful in the way you are accessing it, and you are not reselling the data or using it in a way that might violate copyright laws, you should be fine. Do some research on your own first though and try to find the website’s terms of service.</p>
</section>
<section id="an-example" class="level3" data-number="8.1.2">
<h3 data-number="8.1.2" class="anchored" data-anchor-id="an-example"><span class="header-section-number">8.1.2</span> An Example</h3>
<p>The explanations and examples here are going to be relatively cursory. For a more in-depth explanation of the principles, I recommend reading <a href="https://r4ds.hadley.nz/webscraping">Chapter 24</a> of Wickham et al.&nbsp;in it’s entirety and working through the examples.</p>
<p>The case study we’ll use here is inspired by Chapter 18 of Jacob Kaplan’s <em>Crime by the Numbers: A Criminologist’s Guide to R</em>. Let’s say, for example, that you’re interested in the changing legal norms around the use of marijuana. Less than a week ago, for instance, Germany became just the third country in the European Union to legalize cannabis. More will likely follow. In the United States, around 24 states have legalized its use after a wave of new ballot initiatives in the early 2010s.</p>
<p>Some of these legalization efforts in the U.S. were tied to social justice movements related to the disproportionate impact of cannabis prohibition on the policing of racial and ethnic minorities, especially African Americans. To remedy this, New York State, as one example, has promised to give at least half of all licenses for the sale of legal marijuana to individuals from “communities disproportionately impacted by cannabis prohibition” or belonging to other minority categories (see <a href="https://cannabis.ny.gov/social-and-economic-equity">here</a> for the criteria). The criteria are rather broad, however, and you might have questions about their application and effect in substance. Are they achieving their goals, in other words? Let’s focus on the geographic element here and say that you are interested in studying the geographic diffusion of legalized marijuana dispensaries. This might tell us little about the actual ownership of the dispensaries, but it could tell us something about the neighborhoods that benefit from their presence. Are the dispensaries located primarily in the racial or ethnic-minority neighborhoods that bore the brunt of disproportionate cannabis policing, for example? Or are they instead located in neighborhoods which are higher-income and predominately white?</p>
<p>We have some questions, all we need is the data. Enter the New York State’s Office of Cannabis Management’s website: <a href="https://cannabis.ny.gov/dispensary-location-verification" class="uri">https://cannabis.ny.gov/dispensary-location-verification</a>. It has just the thing we need - a list of marijuana dispensaries in a nice table with addresses. Now we just need to get it into R.</p>
</section>
<section id="using-rvest" class="level3" data-number="8.1.3">
<h3 data-number="8.1.3" class="anchored" data-anchor-id="using-rvest"><span class="header-section-number">8.1.3</span> Using <code>rvest</code></h3>
<p>The package we’ll use for web scraping comes from the <code>tidyverse</code> and is called <code>rvest</code>. It doesn’t load automatically when loading <code>tidyverse</code>, so we’ll need to load it separately.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the libraries</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we need to load the HTML from the web page containing the table into <code>R</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We could load the HTML directly from the Office of Cannabis Management's  </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># website, but for this exercise we'll load it from a copy saved on this </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># course website instead.  It won't change the process or results.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Read from the NYS website</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">#html &lt;- read_html('https://cannabis.ny.gov/dispensary-location-verification')</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Read from the course website</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>html <span class="ot">&lt;-</span> <span class="fu">read_html</span>(<span class="st">'https://wstubenbord.github.io/ScPoSPSSUR/web-scraping-exercise.html'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>html</code> we’ve just created now contains the HTML code for the webpage whose URL we supplied as the argument for the <code>read_html</code> function. HTML contains sets of tags which specify what a particular piece of code produces on the web page. These tags are distinguished with two pairs of brackets, <code>&lt;&gt;</code>. The second set of the pair, which signifies the end of a particular piece of HTML code contains a forward slash, <code>&lt;/&gt;</code>. The following, for example, produces a paragraph:</p>
<pre><code>&lt;p&gt; This is a pargraph... &lt;/p&gt;</code></pre>
<p>In this case, the tags specifying the start and end of a paragraph are <code>&lt;p&gt;</code> and <code>&lt;/p&gt;</code>, respectively, and the letter <code>p</code> indicates that the content is a paragraph. The example below is what a bulleted list looks like in HTML:</p>
<pre><code>&lt;ul&gt;&lt;li&gt;The first bullet in a bulleted list&lt;/li&gt;&lt;/ul&gt;</code></pre>
<p>Here <code>&lt;ul&gt;</code> and <code>&lt;/ul&gt;</code> specify the start and end of an <em>unordered list</em> and <code>&lt;li&gt;</code> and <code>&lt;/li&gt;</code> specify the start and end of a <em>list item</em> (or in this case, a bullet point). You don’t necessarily need to learn HTML to figure out how to get the data you want from an HTML page (although I’m sure it would be helpful), but you do need to be able to identify the tags surrounding the data you are interested in. I personally find that the easiest way to identify them is by right-clicking on the webpage I’m looking at in my browser (I use Chrome, this procedure may be different depending on your browser) and then clicking “View Page Source” on the resulting drop down menu. This opens a page which contains the underlying HTML code. I then use <code>Ctrl</code> + <code>F</code> to search for an element of the data I want to locate in the page (e.g., the name of the first dispensary in the list, ‘Gotham Buds’).</p>
<p>Because HTML can be quite difficult to read in the way it is presented in the source code, I then copy the relevant part of the HTML, throw it into an HTML formatter (whichever is among the first results on Google, something like <a href="https://www.freeformatter.com/html-formatter.html">this</a>), and then examine the structure of the data this way.When you do this, you can see that the HTML table containing the data we want is structured like this:</p>
<pre><code>  &lt;table&gt;
      &lt;thead&gt;
         &lt;tr&gt;
            &lt;th&gt;&lt;strong&gt;Entity Name&lt;/strong&gt;&lt;/th&gt;
            &lt;th&gt;Address&lt;/th&gt;
            &lt;th&gt;City&lt;/th&gt;
            &lt;th&gt;Zip Code&lt;/th&gt;
            &lt;th&gt;Website&lt;/th&gt;
         &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody&gt;
         &lt;tr&gt;
            &lt;td&gt;&lt;strong&gt;1. Gotham Buds&lt;/strong&gt;&lt;/td&gt;
            &lt;td&gt;248 W 125th St&lt;/td&gt;
            &lt;td&gt;New York&lt;/td&gt;
            &lt;td&gt;10027&lt;/td&gt;
            &lt;td&gt;&lt;a href="https://gothambudsny.com" title="Gotham Buds"&gt;&lt;u&gt;gothambudsny.com&lt;/u&gt;&lt;/a&gt;&lt;/td&gt;
         &lt;/tr&gt;
         &lt;tr&gt;</code></pre>
<p>A <code>&lt;table&gt;</code> and <code>&lt;/table&gt;</code> tag appear to be enclosing the entire table (convenient!) and <code>&lt;tr&gt;</code> and <code>&lt;/tr&gt;</code> tags seem to be enclosing each item in the table. Now, back to <code>R</code>.</p>
</section>
<section id="finding-data-in-the-html" class="level3" data-number="8.1.4">
<h3 data-number="8.1.4" class="anchored" data-anchor-id="finding-data-in-the-html"><span class="header-section-number">8.1.4</span> Finding Data in the HTML</h3>
<p>Now that we know where exactly the data is located in the HTML (nested in <code>&lt;table&gt;</code> and <code>&lt;tr&gt;</code> tags), we need to extract it from the <code>html</code> object we read into <code>R</code>.</p>
<p>The <code>html_element()</code> and <code>html_elements()</code> functions from <code>rvest</code> will return HTML element(s) matching the input tag text. <code>html_element()</code> is used when there is only one item (e.g., a table) on the page and <code>html_elements()</code> is used when there are multiple. If we want to find all of the individual line rows in the table in the HTML (which we know are nested in <code>&lt;tr&gt;</code> tags, for example), we can use the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read all of the table row elements(&lt;tr&gt; &lt;/tr&gt;) from the HTML</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>html <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_elements</span>(<span class="st">"tr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{xml_nodeset (102)}
 [1] &lt;tr class="header"&gt;\n&lt;th data-quarto-table-cell-role="th"&gt;&lt;strong&gt;Entity ...
 [2] &lt;tr class="odd"&gt;\n&lt;td&gt;&lt;strong&gt;1. Gotham Buds&lt;/strong&gt;&lt;/td&gt;\n&lt;td&gt;248 W 12 ...
 [3] &lt;tr class="even"&gt;\n&lt;td&gt;&lt;strong&gt;2. Housing Works Cannabis, LLC&lt;/strong&gt;&lt;/ ...
 [4] &lt;tr class="odd"&gt;\n&lt;td&gt;&lt;strong&gt;3. Smacked Village&lt;/strong&gt;&lt;/td&gt;\n&lt;td&gt;144  ...
 [5] &lt;tr class="even"&gt;\n&lt;td&gt;&lt;strong&gt;4. Just Breathe&lt;/strong&gt;&lt;/td&gt;\n&lt;td&gt;75 Cou ...
 [6] &lt;tr class="odd"&gt;\n&lt;td&gt;&lt;strong&gt;5. The Travel Agency Union Square&lt;/strong&gt; ...
 [7] &lt;tr class="even"&gt;\n&lt;td&gt;&lt;strong&gt;6. William Jane Corporation&lt;/strong&gt;&lt;/td&gt; ...
 [8] &lt;tr class="odd"&gt;\n&lt;td&gt;&lt;strong&gt;7. Good Grades, LLC&lt;/strong&gt;&lt;/td&gt;\n&lt;td&gt;162 ...
 [9] &lt;tr class="even"&gt;\n&lt;td&gt;&lt;strong&gt;8. Upstate Canna Co&lt;/strong&gt;&lt;/td&gt;\n&lt;td&gt;16 ...
[10] &lt;tr class="odd"&gt;\n&lt;td&gt;&lt;strong&gt;9. Dazed&lt;/strong&gt;&lt;/td&gt;\n&lt;td&gt;33 Union Sq. W ...
[11] &lt;tr class="even"&gt;\n&lt;td&gt;&lt;strong&gt;10. Legacy Dispensary&lt;/strong&gt;&lt;/td&gt;\n&lt;td&gt; ...
[12] &lt;tr class="odd"&gt;\n&lt;td&gt;&lt;strong&gt;11. Gotham CAURD LLC&lt;/strong&gt;&lt;/td&gt;\n&lt;td&gt;3  ...
[13] &lt;tr class="even"&gt;\n&lt;td&gt;&lt;strong&gt;12. The Cannabis Place&lt;/strong&gt;&lt;/td&gt;\n&lt;td ...
[14] &lt;tr class="odd"&gt;\n&lt;td&gt;&lt;strong&gt;13. Stage One Cannabis LLC&lt;/strong&gt;&lt;/td&gt;\n ...
[15] &lt;tr class="even"&gt;\n&lt;td&gt;&lt;strong&gt;14. Flynnstoned Corporation&lt;/strong&gt;&lt;/td&gt; ...
[16] &lt;tr class="odd"&gt;\n&lt;td&gt;&lt;strong&gt;15. Half Island Flavors LLC***&lt;/strong&gt;&lt;/t ...
[17] &lt;tr class="even"&gt;\n&lt;td&gt;&lt;strong&gt;16. Greenery Spot LLC&lt;/strong&gt;&lt;/td&gt;\n&lt;td&gt; ...
[18] &lt;tr class="odd"&gt;\n&lt;td&gt;&lt;strong&gt;17. Royal Leaf NY&nbsp;LLC&lt;/strong&gt;&lt;/td&gt;\n&lt;td&gt;8 ...
[19] &lt;tr class="even"&gt;\n&lt;td&gt;&lt;strong&gt;18. Strain Stars LLC&lt;/strong&gt;&lt;/td&gt;\n&lt;td&gt;1 ...
[20] &lt;tr class="odd"&gt;\n&lt;td&gt;&lt;strong&gt;19. Exscape INC (dba Sacred Bloom)&lt;/strong ...
...</code></pre>
</div>
</div>
<p>As you can see from the output above, we get a list of all of the rows in the table. If we want to transform the results to text, we can do the following:</p>
<div class="cell" data-r.options="{&quot;max.print&quot;:10}">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn the table rows into text</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>html <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_elements</span>(<span class="st">"tr"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_text2</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Entity Name\tAddress\tCity\tZip Code\tWebsite\t"                                       
 [2] "1. Gotham Buds\t248 W 125th St\tNew York\t10027\tgothambudsny.com\t"                   
 [3] "2. Housing Works Cannabis, LLC\t750 Broadway\tNew York\t10003\thwcannabis.co\t"        
 [4] "3. Smacked Village\t144 Bleecker St\tNew York\t10012\tgetsmacked.online\t"             
 [5] "4. Just Breathe\t75 Court St\tBinghamton\t13901\tjustbreathelife.org\t"                
 [6] "5. The Travel Agency Union Square\t835 Broadway\tNew York\t10003\tthetravelagency.co\t"
 [7] "6. William Jane Corporation\t119-121 E State St\tIthaca\t14850\twilliamjane420.com\t"  
 [8] "7. Good Grades, LLC\t162-03 Jamaica Ave\tJamaica\t11432\tgoodgradesnyc.com\t"          
 [9] "8. Upstate Canna Co\t1613 Union St\tSchenectady\t12309\tupstate-canna.co\t"            
[10] "9. Dazed\t33 Union Sq. W\tNew York\t10003\tdazed.fun\t"                                
 [ reached getOption("max.print") -- omitted 92 entries ]</code></pre>
</div>
</div>
<p>At this point, it would be a matter of storing this text into an object and then starting the very-not-fun, but frequently necessary job of cleaning it. We haven’t deal much with text data in this course and so if you find yourself in the position of needing to clean large amounts of text, I recommend reading and working through <a href="https://r4ds.hadley.nz/strings">Chapters 14</a> and <a href="https://r4ds.hadley.nz/regexps">15</a> of Wickham et al.’s <em>R for Data Science</em>.</p>
<p>Luckily for us though, New York State’s dispensary list comes in a standard HTML table (enclosed with <code>&lt;table&gt;</code> and <code>&lt;/table&gt;</code>) and <em>rvest</em> has a function specifically for it: <code>html_table()</code>. First, we need to specify the name of the tag that starts the table (in this case, “table”) in <code>html_elements()</code>, then we need to pipe the result into the <code>html_table()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the table from the HTML</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>html <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_elements</span>(<span class="st">"table"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_table</span>() <span class="ot">-&gt;</span> dispense</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the results</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>dispense</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
# A tibble: 101 × 5
   `Entity Name`                     Address            City  `Zip Code` Website
   &lt;chr&gt;                             &lt;chr&gt;              &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;  
 1 1. Gotham Buds                    248 W 125th St     New … 10027      gotham…
 2 2. Housing Works Cannabis, LLC    750 Broadway       New … 10003      hwcann…
 3 3. Smacked Village                144 Bleecker St    New … 10012      getsma…
 4 4. Just Breathe                   75 Court St        Bing… 13901      justbr…
 5 5. The Travel Agency Union Square 835 Broadway       New … 10003      thetra…
 6 6. William Jane Corporation       119-121 E State St Itha… 14850      willia…
 7 7. Good Grades, LLC               162-03 Jamaica Ave Jama… 11432      goodgr…
 8 8. Upstate Canna Co               1613 Union St      Sche… 12309      upstat…
 9 9. Dazed                          33 Union Sq. W     New … 10003      dazed.…
10 10. Legacy Dispensary             1839 Central Ave   Alba… 12205      legacy…
# ℹ 91 more rows</code></pre>
</div>
</div>
<p>And just like that, we have what appears to be a tibble containing our desired data. Let’s take a glimpse:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dispense)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 1
 $ : tibble [101 × 5] (S3: tbl_df/tbl/data.frame)
  ..$ Entity Name: chr [1:101] "1. Gotham Buds" "2. Housing Works Cannabis, LLC" "3. Smacked Village" "4. Just Breathe" ...
  ..$ Address    : chr [1:101] "248 W 125th St" "750 Broadway" "144 Bleecker St" "75 Court St" ...
  ..$ City       : chr [1:101] "New York" "New York" "New York" "Binghamton" ...
  ..$ Zip Code   : chr [1:101] "10027" "10003" "10012" "13901" ...
  ..$ Website    : chr [1:101] "gothambudsny.com" "hwcannabis.co" "getsmacked.online" "justbreathelife.org" ...</code></pre>
</div>
</div>
</section>
<section id="data-cleaning" class="level3" data-number="8.1.5">
<h3 data-number="8.1.5" class="anchored" data-anchor-id="data-cleaning"><span class="header-section-number">8.1.5</span> Data Cleaning</h3>
<p>Although it might appear to be a tibble, <code>dispense</code> is a list which contains a tibble as its first item (note that it says “list of 1” at the top - we can also confirm the type of object using <code>class()</code>). The reason why this happened is that we used <code>html_elements()</code> instead of <code>html_element()</code>. Using the plural form, <code>html_elements()</code>, instead of the singular form, <code>html_element()</code>, led <code>html_table()</code> to expect multiple tables. It therefore stored the table in a list of tibbles, rather than as a tibble itself. To get the tibble out of the list, we could do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the first element of the list and store it in dispense</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>dispense_tb <span class="ot">&lt;-</span> dispense[[<span class="dv">1</span>]]</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternatively, we could use the singular form in the first place:</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># html %&gt;%</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">#  html_element("table") %&gt;%</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">#  html_table() -&gt; dispense_tb</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the type</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(dispense_tb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "tbl_df"     "tbl"        "data.frame"</code></pre>
</div>
</div>
<p>The first command uses base <code>R</code> notation to retrieve the first element of a list and store it in <code>dispense_tb</code>. Now we have a proper tibble. There are just a couple of more things that we may want to fix now. The first are the column names. Take a look:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get column names</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dispense_tb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Entity Name" "Address"     "City"        "Zip Code"    "Website"    </code></pre>
</div>
</div>
<p>The column names have spaces in them, which means that we’ll need to use the accent mark (`) to work with them. This can get tedious quickly. We can use a function from <code>janitor</code> to fix all of the column names and put them in a nice, easy to work with format instead.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean the column names</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>dispense_tb <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="ot">-&gt;</span> dispense_tb</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the new column names</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dispense_tb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "entity_name" "address"     "city"        "zip_code"    "website"    </code></pre>
</div>
</div>
<p>The second issue is that the number of the listed dispensary is in the “Entity Name” column instead of in it’s own column. We can fix this using a function from <code>tidyr</code> called <code>separate()</code>. Separate, well, separates a column into multiple columns based on some criteria. In our case, we want to separate the column <code>entity_name</code> into two columns, one with the same name (which contains only the name of the dispensary) and another with the number that was previously in front of that name.</p>
<p>To use <code>separate()</code>, We specify the names of the columns in the <code>into=</code> argument (telling it which columns to put the values into) and the separation criteria in the <code>sep=</code> argument. The separation criteria we need to provide here is essentially a delimiter (which we saw in section 5.5). It tells us where one value begins and the other ends. Let’s try using a blank space as the delimiter, since there is a blank space between the number and <code>entity_name</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate the first two columns using a blank space as the delimiter</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>dispense_tb <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(entity_name,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"number"</span>, <span class="st">"entity_name"</span>), </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">sep =</span> <span class="st">" "</span>, </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">extra =</span> <span class="st">"merge"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 101 × 6
   number entity_name                    address          city  zip_code website
   &lt;chr&gt;  &lt;chr&gt;                          &lt;chr&gt;            &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;  
 1 1.     Gotham Buds                    248 W 125th St   New … 10027    gotham…
 2 2.     Housing Works Cannabis, LLC    750 Broadway     New … 10003    hwcann…
 3 3.     Smacked Village                144 Bleecker St  New … 10012    getsma…
 4 4.     Just Breathe                   75 Court St      Bing… 13901    justbr…
 5 5.     The Travel Agency Union Square 835 Broadway     New … 10003    thetra…
 6 6.     William Jane Corporation       119-121 E State… Itha… 14850    willia…
 7 7.     Good Grades, LLC               162-03 Jamaica … Jama… 11432    goodgr…
 8 8.     Upstate Canna Co               1613 Union St    Sche… 12309    upstat…
 9 9.     Dazed                          33 Union Sq. W   New … 10003    dazed.…
10 10.    Legacy Dispensary              1839 Central Ave Alba… 12205    legacy…
# ℹ 91 more rows</code></pre>
</div>
</div>
<p>This works for the most part, but now we have a period in our number column. A better delimiter might have been the period itself. We can try again using the period in the <code>sep</code> argument instead.</p>
<p>The issue we will run into here, however, is that the <code>sep=</code> argument accepts what is called <strong>regular expression</strong>. Regular expression is a special language, usable across programming languages, which allows us to match patterns in text. The regular expression <code>[0-9]</code>, for example, represents any digit between 0 and 9. If you were to search text for <code>[0-9]</code> using a function that allows regular expression, it would return any single-digit numbers in the text (e.g., 1, 2, or 3, etc.).</p>
<p>The period, <code>.</code>, in regular expression, is a special character which means any single character (e.g., ‘a’ in the word ‘apple’ or ‘b’ in the word ‘banana’). So, we can’t use <code>sep= "."</code> in <code>separate()</code>, because otherwise it will interpret the argument as saying that the first character in the <code>entity_name</code> column is what we’d like to use to separate our columns. To avoid this, we need to use an <strong>escape character</strong> to tell the function that we want to search for an actual period instead of any character. In regular expression, the backslash, <code>\</code>, serves the escape character role. One last complication, in <code>R</code>, when using regular expression, we actually need to use two backslashes as an escape character. In other words, <code>\\.</code> in regular expression in <code>R</code> will represent a regular period: <code>.</code>.</p>
<p>Regular expression is a powerful tool for working with strings. Again, for more on working with this type of data, including the use of regular expression, read <a href="https://r4ds.hadley.nz/strings">Chapters 14</a> and <a href="https://r4ds.hadley.nz/regexps">15</a> of Wickham et al.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate the first two columns using the period as a delimiter</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>dispense_tb <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(entity_name,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"number"</span>, <span class="st">"entity_name"</span>), </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">."</span>, </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">extra =</span> <span class="st">"merge"</span>) <span class="ot">-&gt;</span> dispense_tb</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the results</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>dispense_tb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 101 × 6
   number entity_name                       address       city  zip_code website
   &lt;chr&gt;  &lt;chr&gt;                             &lt;chr&gt;         &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;  
 1 1      " Gotham Buds"                    248 W 125th … New … 10027    gotham…
 2 2      " Housing Works Cannabis, LLC"    750 Broadway  New … 10003    hwcann…
 3 3      " Smacked Village"                144 Bleecker… New … 10012    getsma…
 4 4      " Just Breathe"                   75 Court St   Bing… 13901    justbr…
 5 5      " The Travel Agency Union Square" 835 Broadway  New … 10003    thetra…
 6 6      " William Jane Corporation"       119-121 E St… Itha… 14850    willia…
 7 7      " Good Grades, LLC"               162-03 Jamai… Jama… 11432    goodgr…
 8 8      " Upstate Canna Co"               1613 Union St Sche… 12309    upstat…
 9 9      " Dazed"                          33 Union Sq.… New … 10003    dazed.…
10 10     " Legacy Dispensary"              1839 Central… Alba… 12205    legacy…
# ℹ 91 more rows</code></pre>
</div>
</div>
<p>With this adjustment made, we now get the appropriate columns. One last fix: there’s a blank space in front of the <code>entity_names</code>. We can fix this with the <code>str_trim()</code> or <code>str_squish()</code> functions from the tidyverse.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove the extra space from entity_name</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>dispense_tb <span class="sc">%&gt;%</span> </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">entity_name =</span> <span class="fu">str_trim</span>(entity_name)) <span class="ot">-&gt;</span> dispense_tb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ve now cleaned the data and we can use it for any analysis we may have planned.</p>
</section>
</section>
<section id="making-maps" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="making-maps"><span class="header-section-number">8.2</span> Making Maps</h2>
<p>There are a number of different packages in <code>R</code> that can be used to make maps. We’ll cover two specific examples below: interactive maps using leaflet and choropleth maps using ggplot.</p>
<section id="an-interactive-map" class="level3" data-number="8.2.1">
<h3 data-number="8.2.1" class="anchored" data-anchor-id="an-interactive-map"><span class="header-section-number">8.2.1</span> An Interactive Map</h3>
<p>To make a map, we’ll generally need to obtain the geographic coordinates of the locations we are interested in mapping. For this example, we’ll use the data we collected in our previous web scraping example. The resulting map won’t necessarily be useful for the question we started out with, but it is fun to make nonetheless.</p>
<p>When mapping specific points from addresses, as we have in this case, we need to <em>geocode</em> the addresses into coordinates. We can use the <code>tidygeocoder</code> package for this. The full address in our tibble is actually three separate columns, however: <code>address</code> (the street address), <code>city</code>, and <code>zip_code</code>. So we’ll need to combine them together using the <code>unite()</code> function from <code>tidyr</code>, a package located in the tidyverse. The first argument in <code>unite()</code> is the name of the new column to be created, the second is the vector of columns that need to be merged, and the third, <code>sep=</code>, identifies how you would like the values in each of the old columns to be separated in the new combined column. A blank space here, <code>" "</code>, for example, would put a blank space between element of the address.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a column for the state (NY) and merge the address columns</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>dispense_tb <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="st">"New York"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unite</span>(<span class="st">"full_address"</span>, </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="st">'address'</span>, <span class="st">'city'</span>, <span class="st">'state'</span>, <span class="st">'zip_code'</span>), </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">sep =</span> <span class="st">", "</span>) <span class="ot">-&gt;</span> dispense_tb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once this is done, we can now geocode the full address. The code below would accomplish this, but it takes several minutes to run. To spare you the wait time, I’ve saved a copy of the already geocoded data online, which you can load instantly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the library</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages('tidygeocoder')</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidygeocoder)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Geocode the addresses</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>dispense_tb <span class="sc">%&gt;%</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geocode</span>(full_address) <span class="ot">-&gt;</span> dispense_geo</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the pre-geocoded version instead</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>dispense_geo <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/wstubenbord/ScPoSPSSUR/master/data/dispense_geo.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we’ll use the <code>leaflet</code> library to construct our interactive graph.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the library</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("leaflet")</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the map</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addMarkers</span>(<span class="at">lng =</span> dispense_geo<span class="sc">$</span>long, </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">lat =</span> dispense_geo<span class="sc">$</span>lat,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">popup =</span> <span class="fu">paste</span>(<span class="st">"Name: "</span>,dispense_geo<span class="sc">$</span>entity_name,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"&lt;br&gt;"</span>,</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"Address: "</span>,dispense_geo<span class="sc">$</span>full_address))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item" id="htmlwidget-fd7908e97d3f1a4caf38" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-fd7908e97d3f1a4caf38">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addMarkers","args":[[40.8094281,40.62618505,40.7281194,42.098908,40.7339195,42.4396375,40.7048111,42.80516275,40.73684635,42.7315783,40.72634465,40.7130337,42.6385499,43.0478518,40.8466508,42.1150105,40.8435543,null,null,42.8874025,42.9196164,43.020679,42.4509899,43.2128473,null,40.7748712,40.7187477,44.66930495,42.9475701,null,42.7447804,42.9305705,null,null,40.62595745,null,40.9093071,40.59913245,null,41.3909274,42.68739764999999,40.73112087878788,40.9125085,40.7837447,null,42.8029873,40.76859165,40.74359075,43.0876766,40.7135078,40.52810484160614,40.5724274,41.5176486,40.6452176,42.71684934343434,40.7415095,40.7258727,40.7603338,41.091121,40.5724274,42.6750161,42.7226472,null,41.02987115,44.6951565,40.7808439,40.6978891,41.03052945,40.7492669,42.9785759,null,42.8993462,null,40.5793585,40.7060615,43.034209,40.68372337209302,40.6662026,42.7838643,null,40.8202572,40.753057,40.76116625,42.790156,40.77937305,42.6503934,41.7058461,null,42.4404646,null,42.9655405,42.85643115,40.7470364,40.7431219,40.9034293,null,40.70065415000001,43.1507626,40.77265155,43.2185813,42.8309675],[-73.9498531,-73.71598266071429,-73.9992891,-75.91181109916535,-73.9911173,-76.4955296,-73.7978516,-73.90484657075501,-73.99093673732611,-73.84765040000001,-73.99125430344827,-73.87814193250878,-73.74717339999999,-76.1563561,-73.8785937,-75.9554091,-73.8870831,null,null,-78.87348854757144,-78.6965579,-78.878383,-75.0636537,-75.45573039999999,null,-73.9089097,-73.98964410000001,-74.98717122415061,-78.8600721,null,-73.64178653214285,-74.20814386373826,null,null,-73.73154609415825,null,-73.8499867,-73.96155699699247,null,-74.4765471,-73.84237245140643,-73.45633216666667,-73.83865040000001,-73.95265569999999,null,-78.8294325,-73.95629560134751,-73.99503626549615,-77.63031537490195,-73.8283132,-74.23875870363321,-74.14520777205962,-74.0163278,-73.95819969999999,-73.70821662626263,-73.95697509999999,-73.7187531,-73.917688,-73.91967940000001,-74.14520777205962,-73.7489145,-73.83910539999999,null,-73.78869615082417,-73.5232445,-73.8963152,-73.92938998939597,-73.76546951694378,-73.9520648,-78.8235268,null,-78.8787962,null,-73.9835606,-73.79299810000001,-78.80006081546028,-73.97734051162792,-73.98858389999999,-73.7435722,null,-73.8910655,-73.98053730686502,-73.96112646273605,-73.68832500000001,-73.95604449235933,-73.75201149999999,-73.93594366433314,null,-76.51040039999999,null,-78.870023,-77.01285567321118,-73.94232529999999,-73.9794866,-73.8507652,null,-73.90361116664164,-77.6014959,-73.97989102488057,-77.9381216,-78.7765016],null,null,null,{"interactive":true,"draggable":false,"keyboard":true,"title":"","alt":"","zIndexOffset":0,"opacity":1,"riseOnHover":false,"riseOffset":250},["Name:  Gotham Buds <br> Address:  248 W 125th St, New York, New York, 10027","Name:  Housing Works Cannabis, LLC <br> Address:  750 Broadway, New York, New York, 10003","Name:  Smacked Village <br> Address:  144 Bleecker St, New York, New York, 10012","Name:  Just Breathe <br> Address:  75 Court St, Binghamton, New York, 13901","Name:  The Travel Agency Union Square <br> Address:  835 Broadway, New York, New York, 10003","Name:  William Jane Corporation <br> Address:  119-121 E State St, Ithaca, New York, 14850","Name:  Good Grades, LLC <br> Address:  162-03 Jamaica Ave, Jamaica, New York, 11432","Name:  Upstate Canna Co <br> Address:  1613 Union St, Schenectady, New York, 12309","Name:  Dazed <br> Address:  33 Union Sq. W, New York, New York, 10003","Name:  Legacy Dispensary <br> Address:  1839 Central Ave, Albany, New York, 12205","Name:  Gotham CAURD LLC <br> Address:  3 E 3rd St, New York, New York, 10003","Name:  The Cannabis Place <br> Address:  74-03 Metropolitan Ave, Middle Village, New York, 11379","Name:  Stage One Cannabis LLC <br> Address:  810C Broadway, Rensselaer, New York, 12144","Name:  Flynnstoned Corporation <br> Address:  219 Walton St, Syracuse, New York, 13202","Name:  Half Island Flavors LLC*** <br> Address:  -, Bronx, New York, -","Name:  Greenery Spot LLC <br> Address:  246 Main St, Johnson City, New York, 13790","Name:  Royal Leaf NY LLC <br> Address:  817 E Tremont Ave, Bronx, New York, 10460","Name:  Strain Stars LLC <br> Address:  1815 Broadhollow Rd, Farmingdale, New York, 11735","Name:  Exscape INC (dba Sacred Bloom) <br> Address:  1308 Vestal Pkwy E, 1st Floor, Set D, Vestal, New York, 13850","Name:  Dank 716 LLC <br> Address:  501 Main St, Buffalo, New York, 14203","Name:  Herbal IQ <br> Address:  6055 Transit Rd, Depew, New York, 14043","Name:  EK Green LLC (dba Canterra)*** <br> Address:  -, Tonawanda, New York, -","Name:  Dosha Farms LLC (dba Dosha) <br> Address:  76 Main St, Oneonta, New York, 13820","Name:  Air City Cannabis LLC*** <br> Address:  -, Rome, New York, -","Name:  North County Roots, Inc. (dba Elevate ADK) <br> Address:  622 Lake Flower Ave, Ste 7, Saranac Lake, New York, 12983","Name:  Kush Culture Industry LLC (dba Terp Bros) <br> Address:  3610 Ditmars Blvd, Queens, New York, 11105","Name:  CONBUD LLC <br> Address:  85 Delancey St, New York, New York, 10002","Name:  The Highest Peak, LLC <br> Address:  25 Market St, Potsdam, New York, 13676","Name:  Premier Earth Corp. <br> Address:  1297 Hertel Ave, Buffalo, New York, 14216","Name:  Capital District Cannabis & Wellness Inc. <br> Address:  997 Central Ave, Ste 200, Albany, New York, 12205","Name:  Humble County LLC (dba 420 Bliss) <br> Address:  740 Hoosick Rd, Troy, New York, 12180","Name:  Amsterdam Cannabis, Inc. <br> Address:  1451 State Highway 5S, Amsterdam, New York, 12010","Name:  MJ Dispensary <br> Address:  900 Jefferson Rd, Ste 902, Rochester, New York, 14623","Name:  Cannabis Emporium (dba Hush) <br> Address:  2460 Williamsbridge Rd, Fl 1, Bronx, New York, 10469","Name:  Dagmar Cannabis <br> Address:  412 W Broadway, New York, New York, 10012","Name:  The Firehaus NY <br> Address:  7479 US Highway 11, Potsdam, New York, 13676","Name:  Elevate <br> Address:  127 S Terrace Ave, Mt Vernon, New York, 10550","Name:  Grow Together <br> Address:  2370 Coney Island Ave, Brooklyn, New York, 11223","Name:  TJ's Cannabis Corp. <br> Address:  4205 Long Branch Rd, Ste 5, Liverpool, New York, 13090","Name:  Big Gas Dispensary*** <br> Address:  -, Slate Hill, New York, -","Name:  PharmaCann of New York, LLC (dba Verilife) <br> Address:  10 Executive Park Dr, Albany, New York, 12203","Name:  Happy Days Dispensary, Inc. <br> Address:  105 Route 109, Farmingdale, New York, 11735","Name:  Westchester Harvesting Company (dba Purple Owl Dispensary)*** <br> Address:  -, Mt Vernon, New York, -","Name:  The Herbal Care <br> Address:  1412 Lexington Ave, New York, New York, 10128","Name:  Orange County Cannabis Co. <br> Address:  1308 Dolsontown Rd, Ste 3 & 4, Wawayanda, New York, 10940","Name:  716 Cannabis LLC <br> Address:  2053 Electric Ave, Blasdell, New York, 14219","Name:  WhiteboxTHC, LLC (dba Lenox Hill Cannabis Co.) <br> Address:  334 E 73rd St, New York, New York, 10021","Name:  Verdi <br> Address:  158 W 23rd St, New York, New York, 10011","Name:  Fiorello Pharmaceuticals, Inc. (dba RISE) <br> Address:  556 Jefferson Rd, Rochester, New York, 14623","Name:  Just a Little Higher*** <br> Address:  -, Queens, New York, -","Name:  The Flowery <br> Address:  3022 Veterans Rd W, Staten Island, New York, 10309","Name:  NUGHUB NY*** <br> Address:  -, Staten Island, New York, -","Name:  Curaleaf NY, LLC <br> Address:  8 North Plank Rd, Newburgh, New York, 12550","Name:  BK Exotic <br> Address:  1056 Flatbush Ave, Brooklyn, New York, 11226","Name:  Culture House <br> Address:  958 Sixth Ave, New York, New York, 10001","Name:  Freshly Baked NYC*** <br> Address:  -, Long Island City, New York, -","Name:  New York City Cannabis Exchange <br> Address:  248-09 Jericho Turnpike, Bellerose, New York, 11426","Name:  Urban Weeds <br> Address:  31-35 Steinway St, Astoria, New York, 11103","Name:  Treehouse Cannabis*** <br> Address:  -, Nyack, New York, -","Name:  High Stone*** <br> Address:  -, Staten Island, New York, -","Name:  Royale Flower <br> Address:  332 Northern Blvd, Albany, New York, 12204","Name:  Brownies Dispensary LLC <br> Address:  1686 Central Ave, Albany, New York, 12205","Name:  Northern Lights NY <br> Address:  90 Broadway, Spc 8, Menands, New York, 12204","Name:  Buddega NYC, LLC (dba Cannabis Realm of New York) <br> Address:  475 Central Ave, White Plains, New York, 10606","Name:  Beechnut Ridge Enterprises LLC (dba The Grass Hole Cannabis) <br> Address:  779 State Route 3, Plattsburgh, New York, 12901","Name:  Cannavita <br> Address:  30-30 Steinway St, Astoria, New York, 11103","Name:  The Emerald Dispensary <br> Address:  85 Suydam St, Brooklyn, New York, 11221","Name:  Etain <br> Address:  75 Mamaroneck Ave, White Plains, New York, 10601","Name:  NYCBUD <br> Address:  44-45 Vernon Blvd, Long Island City, New York, 11101","Name:  Puffalo Dreams <br> Address:  900 Niagara Falls Blvd, Buffalo, New York, 14201","Name:  Weed Mart by New Metro <br> Address:  221-50 Horace Harding Expy, Bayside, New York, 11364","Name:  Public Flower <br> Address:  232 Allen St, Buffalo, New York, 14201","Name:  Exit 31 Exotic <br> Address:  255 Genesse St, Utica, New York, 13501","Name:  Tiki Leaves <br> Address:  1511 Neptune Ave, Brooklyn, New York, 11224","Name:  Silk Road NYC <br> Address:  166-30 Jamaica Ave, Jamaica, New York, 11432","Name:  TreeHead Culture <br> Address:  665 North French Rd, Amherst, New York, 14228","Name:  The Travel Agency Downtown Brooklyn <br> Address:  118 Flatbush Ave, Brooklyn, New York, 11217","Name:  Matawana Dispensary <br> Address:  533 5th Ave, Brooklyn, New York, 11215","Name:  The Bakery Cannabis Dispensary <br> Address:  1099 Loudon Rd, Cohoes, New York, 12047","Name:  Raven Dispensaries LLC (dba Raven's Joint) <br> Address:  4106 NY-31, Ste 903, Clay, New York, 13041","Name:  Bronx Joint <br> Address:  925 Hunts Point Ave, Bronx, New York, 10459","Name:  Polanco Brothers <br> Address:  12 East 42nd St, New York, New York, 10017","Name:  Liberty Buds <br> Address:  1115 1st Ave, New York, New York, 10065","Name:  Leafy Peaks <br> Address:  27 B Saratoga Ave, Waterford, New York, 12188","Name:  Bliss + Lex (Weedish LLC) <br> Address:  128 E 86th St, New York, New York, 10028","Name:  Mr Good Vybz <br> Address:  25 N Pearl St, Albany, New York, 12207","Name:  Black Market Canna Co LLC <br> Address:  89 Main St, Poughkeepsie, New York, 12601","Name:  P. Nuggs <br> Address:  4171 State Route 11, Ste 2, Malone, New York, 12953","Name:  Aspire <br> Address:  205 N Fulton St, Ithaca, New York, 14850","Name:  Just Breathe Fingerlakes <br> Address:  2988 US Route 20, Seneca Falls, New York, 13148","Name:  Honey Kenmore (Nickel City Green LLC) <br> Address:  2981 Delaware Ave, Kenmore, New York, 14217","Name:  High Points Dispensary <br> Address:  811 Canandaigua Rd, Geneva, New York, 14456","Name:  Trends Dispensaries, LLC <br> Address:  27-25 44th Dr, Long Island City, New York, 11101","Name:  Smiley Exotics <br> Address:  201 East 30th St, New York, New York, 10016","Name:  Two Buds Dispensary <br> Address:  696 East 241st St, Bronx, New York, 10470","Name:  Platinum Leaf <br> Address:  196 Rock Hill Dr, Rock Hill, New York, 12275","Name:  Late Bloomers NYC LLC <br> Address:  57-01 Myrtle Ave, Ridgewood, New York, 11385","Name:  Good Life Collective <br> Address:  155 Monroe Ave, Rochester, New York, 14607","Name:  Flower Power Dispensers <br> Address:  22 W 66th St, New York, New York, 10023","Name:  Evergreen Retail <br> Address:  51 N Main St, Brockport, New York, 14420","Name:  Devil's Lettuce <br> Address:  650 Orchard Park Rd, West Seneca, New York, 14224"],null,null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[40.52810484160614,44.6951565],"lng":[-78.8787962,-73.45633216666667]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p><br> And there we have it, an interactive map. It’s with noting that <code>&lt;br&gt;</code> is HTML code for a line break (the pop-up labels accept HTML code for formatting, allowing us to customize them even more) and paste is a base <code>R</code> function which allows you to combine character values. See the <code>leaflet</code> documentation or Chapter 18 of Jacob Kaplan’s <a href="https://crimebythenumbers.com/interactive-maps.html"><em>Crime by the Numbers: A Criminologist’s Guide to R</em></a> for more on interactive maps and the options available.</p>
</section>
<section id="choropleth-maps" class="level3" data-number="8.2.2">
<h3 data-number="8.2.2" class="anchored" data-anchor-id="choropleth-maps"><span class="header-section-number">8.2.2</span> Choropleth Maps</h3>
<p>For choropleth maps, we’ll return to our old friend <code>ggplot2</code>. We’ll do a brief demonstration here, but for more details on choropleth maps along with examples (including the source for the maps used here), see <a href="https://socviz.co/maps.html">Chapter 7</a> of Kieran Healy’s <em>Data Visualization</em> textbook. For ideas on some of the many maps which can be made with U.S. Census data, see <a href="https://walker-data.com/census-r/mapping-census-data-with-r.html">Chapter 6</a> of Kyle Walker’s textbook on <em>Analyzing US Census Data: Methods, Maps, and Models in R</em>.</p>
<p>To start, we’ll load data from the 2016 U.S. Presidential Election from the <code>socviz</code> package. We’ll use this to create a choropleth map showing the share of the popular vote won by each candidate. We’ll also load several other necessary packages: <code>maps</code>, <code>ggthemes</code>, and, of course, <code>tidyverse</code> if you don’t have it loaded already.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the extra libraries</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(maps)       <span class="co"># Contains pre-drawn maps</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(socviz)     <span class="co"># Contains the election data</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggthemes)   <span class="co"># Contains theme_map(), a ggplot theme for map drawing</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(election)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Essentially, <code>ggplot</code> creates maps by drawing lines over the blank graph canvas. So, the form of the piped <code>ggplot</code> functions will look familiar. To obtain the coordinates necessary to draw the lines for the map, we need data from the <code>maps</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Take the lines for the states from `maps`</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>us_states <span class="ot">&lt;-</span> <span class="fu">map_data</span>(<span class="st">"state"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we need to merge these into the election data from <code>socviz</code>. To ensure they merge correctly, we need to make the states in the election data lower case and we also need to ensure that the names of the columns that we’re merging match.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Change to lower case</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>election<span class="sc">$</span>state <span class="ot">&lt;-</span> <span class="fu">tolower</span>(election<span class="sc">$</span>state)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace region in the election data with state</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># to make the merge easier</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>election<span class="sc">$</span>region <span class="ot">&lt;-</span> <span class="fu">tolower</span>(election<span class="sc">$</span>state)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>us_states_elec <span class="ot">&lt;-</span> <span class="fu">left_join</span>(us_states, </span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>                            election, </span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">by =</span> <span class="fu">join_by</span>(region))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can make the choropleth maps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>us_states_elec <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> long, </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y =</span> lat,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">group =</span> group,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fill =</span> pct_trump))<span class="sc">+</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_polygon</span>(<span class="at">color =</span> <span class="st">"gray90"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_map</span>(<span class="at">projection =</span> <span class="st">"albers"</span>, </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">lat0 =</span> <span class="dv">39</span>, </span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">lat1 =</span> <span class="dv">45</span>) <span class="sc">+</span> </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"white"</span>, </span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">high =</span> <span class="st">"#CB454A"</span>,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">100</span>)) <span class="sc">+</span> </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_map</span>() <span class="sc">+</span> </span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>) <span class="sc">+</span> </span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"Percent"</span>) <span class="ot">-&gt;</span> p_trump</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>p_trump</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="scraping-and-maps_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The choropleth map above shows the proportion of the popular vote Trump received in each state. Note that <code>theme_map()</code> gets rid of much of the background plot features that aren’t useful for maps (like axes). <code>coord_map()</code> specifies the range of latitudes we need for our map and the type of map projection we want to use (Albers projections generally look nicer).</p>
<p>We can now do the same with Hillary Clinton’s vote share.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>us_states_elec <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> long, </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y =</span> lat,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">group =</span> group,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fill =</span> pct_clinton))<span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_polygon</span>(<span class="at">color =</span> <span class="st">"gray90"</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_map</span>(<span class="at">projection =</span> <span class="st">"albers"</span>, </span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">lat0 =</span> <span class="dv">39</span>, </span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">lat1 =</span> <span class="dv">45</span>) <span class="sc">+</span> </span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"white"</span>, </span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">high =</span> <span class="st">"#2E74C0"</span>,</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">100</span>)) <span class="sc">+</span> </span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_map</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>) <span class="sc">+</span> </span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"Percent"</span>) <span class="ot">-&gt;</span> p_clinton</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>p_clinton</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="scraping-and-maps_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="exercises" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="exercises"><span class="header-section-number">8.3</span> Exercises</h2>
<ol type="1">
<li><p>Play around with the settings for the maps above. Try adding a title. Change the limits of the <code>scale_fill_gradient</code>. Alter the latitudes or see what other project map types look like.</p></li>
<li><p>Choose another choropleth map from <a href="https://socviz.co/maps.html">Chapter 7</a> of Data Visualization and try to recreate it.</p></li>
</ol>


</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>How do we know if a website allows web-scraping or not? Usually, web sites contain <em>terms and conditions.</em> Sometimes, those terms and conditions will specifically prohibit web scraping. Whether those terms and conditions are legally enforceable is a different matter, however.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./inference-continued.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Linear Regression and Inference for Categorical Data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./homework-1.html" class="pagination-link">
        <span class="nav-page-text">Homework 1</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>